<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Start Your Screening - Rhea Health</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit&onload=tsOnload" async defer></script>
</head>
<body>
  <div id="header-placeholder"></div>

  <main class="section">
    <section class="team">
      <h2>Start Your Screening Journey</h2>
      <p>Please provide the details below and we'll follow up with next steps. We only ask what's necessary — you can always provide more information later.</p>

      <form id="lead-form" class="lead-form" method="post" action="/api/lead">
        <div class="fields">
          <input type="email" name="email" placeholder="Email address" required>
          <input type="text" name="first_name" placeholder="First name (optional)">
        </div>

        <div class="fields">
          <input type="tel" name="phone" placeholder="Phone (optional)">
          <select name="planning_timeframe" aria-label="Planning timeframe">
            <option value="">Planning timeframe (optional)</option>
            <option value="trying_now">Trying now</option>
            <option value="0_6_months">0–6 months</option>
            <option value="6_12_months">6–12 months</option>
            <option value="gt_12_months">&gt;12 months</option>
          </select>
        </div>

        <div class="privacy-note" role="note">
          <strong>PDPA Notice:</strong> By submitting this form, you acknowledge that Rhea Health will collect, use and disclose your personal data provided here for the purposes of responding to your enquiry, providing screening-related information, arranging services and associated administration, in accordance with our <a href="privacy.html" target="_blank" rel="noopener">Privacy Notice</a>.
        </div>

        <label class="checkbox-row">
          <input type="checkbox" name="pdpa_ack" required>
          <span>I have read the Privacy Notice and consent to the collection, use and disclosure of my personal data for the purposes stated above.</span>
        </label>

        <label class="checkbox-row">
          <input type="checkbox" name="consent">
          <span>I agree to receive occasional updates from Rhea Health via email (optional).</span>
        </label>

        <div class="privacy-hint">
          Email is required to process your request and share screening instructions/results; other fields are optional. We do not send marketing SMS/calls unless you have given express consent. You may withdraw your consent at any time as described in the Privacy Notice.
        </div>

        <div class="verify-row">
          <label for="turnstile-widget" class="visually-hidden">Human verification</label>
          <div id="turnstile-widget" aria-hidden="true" tabindex="-1" class="turnstile-mount"></div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">Get Started</button>
          <button type="button" id="reset-btn" class="btn btn-secondary">Reset</button>
          <div id="lead-msg" class="lead-msg" aria-live="polite" style="margin-left:.5rem;color:var(--muted);"></div>
        </div>

        <!-- Hidden fields for tracking, filled by JS -->
        <input type="hidden" name="page" value="">
        <input type="hidden" name="referrer" value="">
        <input type="hidden" name="utm_source" value="">
        <input type="hidden" name="utm_medium" value="">
        <input type="hidden" name="utm_campaign" value="">
        <!-- Turnstile token (invisible mode sets via callback)-->
        <input type="hidden" name="cf-turnstile-response" value="">
      </form>

    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    // load header/footer like other pages
    (async function loadComponents(){
      const h = document.getElementById('header-placeholder');
      const f = document.getElementById('footer-placeholder');
      if (h) h.innerHTML = await fetch('header.html').then(r=>r.text());
      if (f) f.innerHTML = await fetch('footer.html').then(r=>r.text());
    })();

    // Lead form submission: POST to your edge function or Netlify function at /api/lead
    (function(){
      const form = document.getElementById('lead-form');
      const msg = document.getElementById('lead-msg');
      if (!form) return;

      // populate hidden fields
      function populateTracking() {
        const params = new URLSearchParams(location.search);
        form.querySelector('input[name="page"]').value = location.pathname + location.hash;
        form.querySelector('input[name="referrer"]').value = document.referrer || '';
        form.querySelector('input[name="utm_source"]').value = params.get('utm_source') || '';
        form.querySelector('input[name="utm_medium"]').value = params.get('utm_medium') || '';
        form.querySelector('input[name="utm_campaign"]').value = params.get('utm_campaign') || '';
      }
      populateTracking();

      // Turnstile: explicit render + compact mode for debugging
      const tokenInput = form.querySelector('input[name="cf-turnstile-response"]');
      const submitBtn = form.querySelector('button[type="submit"]');
      let tsResolve = null;
      let tsWidgetId = null;

      // Disable submit until Turnstile passes
      function updateSubmitDisabled() {
        submitBtn.disabled = !tokenInput.value;
      }

      // Called by Turnstile API once it loads (see script onload param)
      window.tsOnload = function(){
        try {
          // Render Turnstile widget with a valid size
          tsWidgetId = turnstile.render('#turnstile-widget', {
            sitekey: '0x4AAAAAABz6lSujAk1FM-sC',
            size: 'compact', // Compact widget for fallback visibility
            callback: function(token){ window.tsCallback(token); },
            'error-callback': function(){ window.tsError(); },
            'expired-callback': function(){ window.tsExpired(); },
          });
        } catch (e) {
          console.error('Failed to render Turnstile widget', e);
        }
      };

      async function waitForTurnstile(timeoutMs = 5000){
        const start = Date.now();
        while (!(window.turnstile && (tsWidgetId !== null))) {
          if (Date.now() - start > timeoutMs) return false;
          await new Promise(r => setTimeout(r, 50));
        }
        return true;
      }
      window.tsCallback = function(token){
        tokenInput.value = token || '';
        updateSubmitDisabled();
        if (typeof tsResolve === 'function') { const r = tsResolve; tsResolve = null; r(token); }
        // Removed automatic form submission to allow manual submission by the user
      };
      window.tsExpired = function(){ tokenInput.value = ''; updateSubmitDisabled(); };
      window.tsError = function(){ tokenInput.value = ''; updateSubmitDisabled(); if (typeof tsResolve === 'function') { const r = tsResolve; tsResolve = null; r(null); } };

      // Ensure initial disabled state
      updateSubmitDisabled();

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        msg.textContent = '';
        submitBtn.disabled = true;

        // Enforce native required fields (e.g., PDPA checkbox)
        if (!form.checkValidity()) {
          form.reportValidity();
          // Re-enable only if token already present
          updateSubmitDisabled();
          return;
        }

        let data = Object.fromEntries(new FormData(form).entries());

        // Ensure Turnstile token present; if missing, execute widget
        if (!data['cf-turnstile-response']) {
          try {
            turnstile.execute(tsWidgetId); // Trigger Turnstile execution
          } catch (err) {
            console.error('Turnstile execution failed', err);
            msg.textContent = 'Verification failed — please try again.';
            submitBtn.disabled = false;
          }
          return;
        }

        try {
          const resp = await fetch('/api/lead', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!resp.ok) throw new Error('Network response was not ok');
          msg.textContent = 'Thanks — we\'ll be in touch.';
          // Optionally redirect to a thank-you page
          //setTimeout(()=>{ window.location.href = '/thank-you.html'; }, 900);
        } catch(err) {
          console.error(err);
          msg.textContent = 'Submission failed — please try again.';
          updateSubmitDisabled();
        }
      });

      // Reset button functionality
      document.getElementById('reset-btn').addEventListener('click', () => {
        form.reset(); // Clear all form fields
        msg.textContent = ''; // Clear the message
        submitBtn.disabled = true; // Keep disabled until Turnstile passes again
        try { if (window.turnstile) window.turnstile.reset(tsWidgetId ?? '#turnstile-widget'); } catch {}
      });
    })();
  </script>

</body>
</html>
